<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>¡Has Recibido un Regalo!</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f0f0f0; }
        canvas { width: 100%; height: 100%; display: block; }
        #loading-indicator {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             color: black; font-family: sans-serif; font-size: 1.2em; display: block;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
<div id="loading-indicator">Cargando tu regalo...</div>

<script type="module">
    // --- IMPORTS DE THREE.JS ---
    const THREE = await import('three');
    const { GLTFLoader } = await import('three/addons/loaders/GLTFLoader.js');
    const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
    const { DRACOLoader } = await import('three/addons/libs/draco/gltf/DRACOLoader.js');

    // --- IMPORTS DE FIREBASE ---
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getFirestore, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
    const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js");

    // --- VARIABLES GLOBALES (Lógica 3D) ---
    let scene, camera, renderer, controls, gltfModel, mixer, clock, animations;
    const textureLoader = new THREE.TextureLoader();
    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    let estadoApp3D = "INICIO";
    let datosDelRegalo = null;

    const NOMBRES = {
        CAJA: "Caja", MESA: "Mesa_Apoyo", SOBRE: "Sobre", SOLAPA: "Solapa", TARJETA: "Tarjeta", TAPA: "Tapa",
        CINTA1: "Cinta1", CINTA2: "Cinta2", LAZO_ESTRELLA: "Lazoestrella", LAZO_FLOR: "Lazoflor",
        LAZO_NORMAL: "Lazonormal", LAZO_DORADO: "Lazodorado"
    };
    const PAPELES = ["Papel_Frontal", "Papel_Trasero", "Papel_Izquierdo", "Papel_Derecho", "Papel_Inferior", "Papel_Superior"];
    const LAZOS = [NOMBRES.LAZO_ESTRELLA, NOMBRES.LAZO_FLOR, NOMBRES.LAZO_NORMAL, NOMBRES.LAZO_DORADO];

    // --- LÓGICA PRINCIPAL (FIREBASE + 3D) ---
    const urlParams = new URLSearchParams(window.location.search);
    const regaloId = urlParams.get('id');

    if (!regaloId) {
        document.getElementById('loading-indicator').textContent = 'Error: ID de regalo no encontrado.';
    } else {
        document.getElementById('loading-indicator').textContent = `Cargando datos del regalo...`;

        const firebaseConfig = {
          apiKey: "AIzaSyCquRXJVV6E3_M6p_EZortgqiRDGyUpIOQ",
          authDomain: "para-ti-v02.firebaseapp.com",
          projectId: "para-ti-v02",
          storageBucket: "para-ti-v02.firebasestorage.app",
          messagingSenderId: "168355699533",
          appId: "1:168355699533:web:9972cc1625bba095b97504",
          measurementId: "G-RL8NML8EKT"
        };
        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        const db = getFirestore(app);

        try {
            const docRef = doc(db, "regalos", regaloId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                datosDelRegalo = docSnap.data();
                console.log("Datos del regalo obtenidos:", datosDelRegalo);
                init3D();
                animate();
            } else {
                document.getElementById('loading-indicator').textContent = 'Error: El regalo no existe o ha sido eliminado.';
            }
        } catch (error) {
            console.error("Error al obtener el regalo de Firestore:", error);
            document.getElementById('loading-indicator').textContent = 'Error al cargar los datos del regalo.';
        }
    }

    function init3D() {
        scene = new THREE.Scene();
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        clock = new THREE.Clock();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.8, 5);
        camera.lookAt(0, 0.5, 0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 0.5, 0);
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('/assets/html3d/libs/draco/');
        const loader = new GLTFLoader();
        loader.setDRACOLoader(dracoLoader);
        const modelPath = '/assets/texturas/packages/caja_base.glb';
        loader.load(modelPath, (gltf) => {
            document.getElementById('loading-indicator').style.display = 'none';
            gltfModel = gltf.scene;
            scene.add(gltfModel);
            const box = new THREE.Box3().setFromObject(gltf.scene);
            const center = box.getCenter(new THREE.Vector3());
            gltfModel.position.y -= center.y;
            controls.target.copy(center);
            if (gltf.animations && gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(gltf.scene);
                animations = gltf.animations;
            }
            aplicarPersonalizaciones(datosDelRegalo);
            renderer.domElement.addEventListener('pointerdown', onCanvasPointerDown, false);
        }, undefined, (error) => {
            console.error('Error cargando GLB:', error);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if (controls) controls.update();
        if (mixer) mixer.update(delta);
        renderer.render(scene, camera);
    }

    function onCanvasPointerDown(event) {
        pointer.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
        pointer.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
        raycaster.setFromCamera(pointer, camera);
        if (!gltfModel) return;
        const intersects = raycaster.intersectObject(gltfModel, true);

        if (intersects.length > 0) {
            const primerObjetoTocado = intersects[0].object;
            if (!primerObjetoTocado.isMesh || !primerObjetoTocado.visible) return;
            console.log(`Tocado: ${primerObjetoTocado.name}, Estado: ${estadoApp3D}`);

            if (estadoApp3D === "INICIO" && (primerObjetoTocado.name === NOMBRES.SOBRE || primerObjetoTocado.name === NOMBRES.SOLAPA)) {
                estadoApp3D = "ANIMANDO_SOBRE_TARJETA";
                const tarjetaObj = gltfModel.getObjectByName(NOMBRES.TARJETA);
                if (tarjetaObj) tarjetaObj.visible = true;
                playAnimacion("Tarjeta_Salir", () => { estadoApp3D = "TARJETA_MOSTRADA"; });
                playAnimacion("Solapa_Abrir");
            } else if (estadoApp3D === "TARJETA_MOSTRADA" && primerObjetoTocado.name === NOMBRES.TARJETA) {
                alert(`Mensaje para ti:\n\n${datosDelRegalo.mensaje.replace(/\\n/g, '\n')}`);
                [NOMBRES.TARJETA, NOMBRES.SOBRE, NOMBRES.SOLAPA].forEach(nombre => {
                    const obj = gltfModel.getObjectByName(nombre);
                    if(obj) obj.visible = false;
                });
                if (controls) controls.reset();
                estadoApp3D = "TARJETA_LEIDA";
            // CÓDIGO NUEVO Y CORRECTO
            // CÓDIGO NUEVO Y CORRECTO PARA TU ESTRUCTURA
            } else if (estadoApp3D === "TARJETA_LEIDA" && datosDelRegalo && primerObjetoTocado.name === datosDelRegalo.formaLazo) {
                estadoApp3D = "ABRIENDO_REGALO";
                console.log("Iniciando secuencia de apertura para estructura raíz...");

                // 1. Animar la caída de los lazos y cintas.
                //    Cuando termine, ocultamos el objeto Vacío que los contiene.
                playAnimacion("LazosCintas_Caer", () => {
                    console.log("Animación de lazos finalizada. Ocultando Vacio_LazosCintas.");
                    const lazosContainer = gltfModel.getObjectByName("Vacio_LazosCintas");
                    if (lazosContainer) lazosContainer.visible = false;
                });

                // 2. Un instante después, iniciamos la caída de todos los papeles.
                setTimeout(() => {
                    console.log("Iniciando animación de papeles...");
                    PAPELES.forEach(nombrePapel => {
                        // Cada papel se anima y se oculta a sí mismo cuando termina.
                        playAnimacion(`${nombrePapel}_Caer`, () => {
                            const papelObj = gltfModel.getObjectByName(nombrePapel);
                            if (papelObj) papelObj.visible = false;
                        });
                    });
                }, 100); // Retraso de 100ms para un efecto escalonado.

                // 3. Después de un tiempo prudencial para que se despeje la tapa, la abrimos.
                //    Ajusta este valor (en milisegundos) según la duración de tus animaciones de caída.
                setTimeout(() => {
                    console.log("Iniciando animación de la tapa...");
                    playAnimacion("Tapa_Abrir", () => {
                        console.log("¡Regalo completamente abierto!");
                        estadoApp3D = "REGALO_ABIERTO";
                        // 4. Notificamos a Kotlin que la secuencia ha terminado.
                        if (window.AndroidBridge) {
                            window.AndroidBridge.onAnimacionAperturaCompleta();
                        }
                    });
                }, 500); // La tapa empieza a abrirse medio segundo después del inicio.
            }
        }
    }

    function aplicarPersonalizaciones(datos) {
        if (!gltfModel || !datos) return;
        applyTexture(NOMBRES.MESA, `/assets/texturas/table/${datos.texturaMesa}`, true);
        applyTexture(NOMBRES.SOBRE, "/assets/texturas/details/PaperText02.jpg", true);
        applyTexture(NOMBRES.SOLAPA, "/assets/texturas/details/PaperText02.jpg", true);
        applyTexture(NOMBRES.CAJA, `/assets/texturas/packages/${datos.texturaCaja}`);
        PAPELES.forEach(p => applyTexture(p, `/assets/texturas/paper/${datos.texturaPapel}`));
        if (datos.texturaTarjeta && datos.mensaje) {
            crearTexturaTarjetaConTexto(datos.texturaTarjeta, datos.mensaje);
        }
        LAZOS.forEach(nombreLazo => {
            const lazoObj = gltfModel.getObjectByName(nombreLazo);
            if (lazoObj) lazoObj.visible = false;
        });
        if (datos.formaLazo && datos.colorLazo && datos.acabadoLazo) {
            applyColorAndFinish(datos.formaLazo, datos.colorLazo, datos.acabadoLazo, datos.detalleCinta, true);
            applyColorAndFinish(NOMBRES.CINTA1, datos.colorLazo, datos.acabadoLazo, datos.detalleCinta, true);
            applyColorAndFinish(NOMBRES.CINTA2, datos.colorLazo, datos.acabadoLazo, datos.detalleCinta, true);
        } else {
            [NOMBRES.CINTA1, NOMBRES.CINTA2].forEach(n => {
                const o = gltfModel.getObjectByName(n);
                if(o) o.visible = false;
            });
        }
    }

    function playAnimacion(nombreAnim, onFinishedCallback) {
        if (!mixer || !animations) { if (onFinishedCallback) onFinishedCallback(); return null; }
        const clip = THREE.AnimationClip.findByName(animations, nombreAnim);
        if (!clip) { console.warn(`Animación '${nombreAnim}' no encontrada.`); if (onFinishedCallback) onFinishedCallback(); return null; }
        const action = mixer.clipAction(clip);
        action.reset().setLoop(THREE.LoopOnce, 1).play();
        action.clampWhenFinished = true;
        if (onFinishedCallback) {
            const listener = (e) => { if (e.action === action) { mixer.removeEventListener('finished', listener); onFinishedCallback(); } };
            mixer.addEventListener('finished', listener);
        }
        return action;
    }

    function applyTexture(meshName, fullPath, forceMaterial = false) {
        textureLoader.load(fullPath, (texture) => {
            texture.flipY = false;
            texture.colorSpace = THREE.SRGBColorSpace;
            const obj = gltfModel.getObjectByName(meshName);
            if (obj && obj.isMesh) {
                if (forceMaterial && !obj.material.isMeshStandardMaterial) { obj.material = new THREE.MeshStandardMaterial(); }
                obj.material.color.set(0xffffff);
                obj.material.map = texture;
                obj.material.needsUpdate = true;
            }
        }, undefined, (err) => console.error(`Error cargando textura: ${fullPath}`, err));
    }

    function applyColorAndFinish(meshName, colorHex, acabado, detalleCintaPath, makeVisible = false) {
        const obj = gltfModel.getObjectByName(meshName);
        if (obj && obj.isMesh) {
            obj.material.color.set(colorHex);
            obj.material.roughness = (acabado === 'mate') ? 0.9 : 0.1;
            obj.material.metalness = (acabado === 'mate') ? 0.1 : 0.8;
            if (detalleCintaPath && detalleCintaPath !== "") { applyTexture(meshName, `/assets/texturas/details/${detalleCintaPath}`); } else { obj.material.map = null; }
            obj.material.needsUpdate = true;
            if (makeVisible) obj.visible = true;
        }
    }

    function crearTexturaTarjetaConTexto(imagenFondo, texto) {
        const tarjetaObj = gltfModel.getObjectByName(NOMBRES.TARJETA);
        if (!tarjetaObj) return;
        const rutaFondo = `/assets/texturas/cards/${imagenFondo}`;
        const imgLoader = new THREE.ImageLoader();
        imgLoader.load(rutaFondo, (image) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width; canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            ctx.fillStyle = '#2c2c2c';
            ctx.font = 'bold 52px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 5;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            const lineas = texto.split('\\n');
            const alturaLinea = 60;
            const yInicial = (canvas.height / 2) - ((lineas.length - 1) * alturaLinea / 2);
            lineas.forEach((linea, index) => { ctx.fillText(linea, canvas.width / 2, yInicial + (index * alturaLinea)); });
            const texturaCanvas = new THREE.CanvasTexture(canvas);
            texturaCanvas.flipY = false;
            texturaCanvas.colorSpace = THREE.SRGBColorSpace;
            tarjetaObj.material.map = texturaCanvas;
            tarjetaObj.material.needsUpdate = true;
        });
    }

</script>
</body>
</html>